const express = require('express');
const line = require('@line/bot-sdk');
const app = express();

const config = {
  channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.CHANNEL_SECRET,
};

const client = new line.Client(config);

// Flood protection: store user message timestamps
const userLastMessage = {};

app.post('/webhook', line.middleware(config), (req, res) => {
  Promise.all(req.body.events.map(handleEvent)).then(result => res.json(result));
});

function handleEvent(event) {
  if (event.type !== 'message' || event.message.type !== 'text') {
    return Promise.resolve(null);
  }

  const userId = event.source.userId;
  const now = Date.now();

  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô flood: ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö
  if (userLastMessage[userId] && now - userLastMessage[userId] < 8000) {
    return Promise.resolve(null);
  }
  userLastMessage[userId] = now;

  const msg = event.message.text.toLowerCase().trim();
  const hour = new Date().getHours();
  const isNight = hour >= 21 || hour < 7;
  const isPhone = /^0[689]\d{8}$/.test(msg.replace(/[^0-9]/g, ''));

  let reply = '';

  if (msg.includes('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤') || msg.includes('‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß')) {
    reply = 'üìå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3‚Äì5 ‡∏ô‡∏≤‡∏ó‡∏µ\n‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡πà‡∏ß‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üí¨\nüëâ https://lin.ee/INWaq47';
  } else if ((msg.includes('‡∏ñ‡∏≠‡∏ô') && msg.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤')) || msg.includes('‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô')) {
    reply = 'üì§ ‡∏´‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 3‚Äì5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞\n‡∏´‡∏≤‡∏Å‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ó‡∏±‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ üí¨\nüëâ https://lin.ee/INWaq47';
  } else if (msg.includes('‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™') || msg.includes('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï')) {
    reply = 'üîê ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?\n‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤\n‡πÅ‡∏Ñ‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üëá\n‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£\n‚Ä¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£\n‚Ä¢ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£\n‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
  } else if (msg.includes('‡πÇ‡∏õ‡∏£') || msg.includes('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô') || msg.includes('‡∏Ç‡∏≠‡πÇ‡∏õ‡∏£')) {
    reply = 'üéÅ ‡πÇ‡∏õ‡∏£‡πÄ‡∏î‡πá‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ! ‡∏ù‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ó‡∏±‡∏ô‡∏ó‡∏µ üî•\n‡∏™‡∏ô‡πÉ‡∏à‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£ ‡∏ó‡∏±‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üëá\nüí¨ https://lin.ee/INWaq47';
  } else if (msg.includes('‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà') || msg.includes('‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥') || msg.includes('‡∏ó‡∏≥‡∏¢‡∏≠‡∏î')) {
    reply = '‚úÖ ‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ ‚Äú‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏¢‡∏≠‡∏î‚Äù ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞\n‡∏à‡∏∞‡∏ù‡∏≤‡∏Å 1 ‡∏ö‡∏≤‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≠‡∏ô 5 ‡∏ö‡∏≤‡∏ó‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏î üòç\n‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏á‡πà‡∏≤‡∏¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ üí∏';
  } else if (
    msg.includes('‡∏™‡∏°‡∏±‡∏Ñ‡∏£') || msg.includes('‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£') ||
    msg.includes('‡∏Ç‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£') || msg.includes('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢')
  ) {
    reply =
`üìå ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üëá\nüîó https://play.onedollar.bet/signup?ref=xtcqTA

‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡πâ üí¨\n‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤:\n‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô\n‚Ä¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£\n‚Ä¢ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ\n‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ï

üìç ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏≠‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üí∏`;
  } else if (
    msg.includes('‡πÄ‡∏Å‡∏°‡πÑ‡∏´‡∏ô‡∏î‡∏µ') || msg.includes('‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ') ||
    msg.includes('‡πÄ‡∏Å‡∏°‡πÑ‡∏´‡∏ô‡πÅ‡∏ï‡∏Å') || msg.includes('‡πÄ‡∏Å‡∏°‡πÑ‡∏´‡∏ô‡πÅ‡∏à‡∏Å')
  ) {
    reply =
`üéÆ ‡πÅ‡∏≠‡∏î‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ô‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üî•

üÉè ‡∏õ‡πä‡∏≠‡∏Å‡πÄ‡∏î‡πâ‡∏á ‚Äì ‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡∏°‡∏≤‡∏Å!\nüé∞ ‡∏™‡∏•‡πá‡∏≠‡∏ï ‚Äì ‡∏•‡∏∏‡πâ‡∏ô‡∏°‡∏±‡∏ô‡∏™‡πå ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏ï‡∏Å‡∏ö‡πà‡∏≠‡∏¢\nü•ä ‡∏°‡∏ß‡∏¢‡∏™‡∏î ‚Äì ‡πÅ‡∏ó‡∏á‡∏™‡∏î‡∏•‡∏∏‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå\nüíµ ‡∏ö‡∏≠‡∏• ‚Äì ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏•‡∏µ‡∏Å ‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πà‡∏≤‡∏¢

‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ß‡πÑ‡∏´‡∏ô ‡πÅ‡∏≠‡∏î‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ üòò`;
  } else if (isPhone) {
    reply = 'üì≤ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≤ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä';
  } else if (msg.includes('‡∏Ç‡∏≠‡∏™‡∏•‡∏¥‡∏õ') || msg.includes('‡∏™‡∏•‡∏¥‡∏õ')) {
    reply = 'üìé ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡∏ô‡∏∞‡∏Ñ‡∏∞\n‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíï';
  } else {
    reply = isNight
      ? '‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏Å ‡πÜ ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏à‡∏ï‡∏≠‡∏ö‡∏ä‡πâ‡∏≤‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ü•±\n‡πÅ‡∏ï‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡πâ‡∏≤ üëá\nüîó https://play.onedollar.bet/signup?ref=xtcqTA'
      : '‡∏´‡∏≤‡∏Å‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üëá\nüîó https://play.onedollar.bet/signup?ref=xtcqTA\n‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡πâ‡∏Å‡πá‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤ üòä';
  }

  return client.replyMessage(event.replyToken, {
    type: 'text',
    text: reply,
  });
}

app.get('/', (req, res) => {
  res.send('LINE Webhook Bot is running!');
});

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`Server is running on port ${port}`);
});
